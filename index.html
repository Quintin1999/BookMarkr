<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookMarkr</title>
</head>
<body>
    <h1>API Testing Form</h1>

    <!-- Create User -->
    <h2>Create User</h2>
    <form action="http://localhost:3000/api/users/create" method="POST">
        <label for="username">Username:</label>
        <input type="text" name="username" id="username" required><br>

        <label for="email">Email:</label>
        <input type="email" name="email" id="email" required><br>

        <label for="password">Password:</label>
        <input type="password" name="password" id="password" required><br>

        <button type="submit">Create User</button>
    </form>

    <!-- Login -->
    <h2>Login</h2>
    <form id="loginForm">
        <label for="loginEmail">Email:</label>
        <input type="email" id="loginEmail" name="email" required><br>

        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" name="password" required><br>

        <button type="submit">Login</button>
    </form>

    <!-- Create Club -->
    <h2>Create Club</h2>
    <form id="createClubForm">
        <label for="name">Club Name:</label>
        <input type="text" name="name" id="name" required><br>

        <label for="description">Description:</label>
        <input type="text" name="description" id="description"><br>

        <label for="roomKey">Room Key:</label>
        <input type="text" name="roomKey" id="roomKey" required><br>

        <button type="button" id="createClubButton">Create Club</button> <!-- Change to 'button' type -->
    </form>

    <!-- Search Google Books -->
    <h2>Search Google Books</h2>
    <form id="searchBooksForm">
        <label for="query">Search:</label>
        <input type="text" name="query" id="query" required>
        <button type="button" id="searchBooksButton">Search</button>
    </form>
        <div id="searchResults"></div>

    <script>
        // Login form submission
        async function submitLoginForm(event) {
            event.preventDefault(); // Prevent default form submission

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('http://localhost:3000/api/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),  // Send email and password
                });

                const result = await response.json();

                if (response.ok) {
                    // Store the token in localStorage
                    localStorage.setItem('jwtToken', result.token);
                    alert('Login successful');
                    console.log('Token:', result.token);
                } else {
                    alert('Login failed: ' + result.message);
                }
            } catch (error) {
                console.error('Error during login:', error);
                alert('Error during login');
            }
        }

        // Create club form submission
        async function submitCreateClubForm(event) {
            event.preventDefault(); // Prevent default form submission

            const form = document.getElementById('createClubForm');
            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                roomKey: formData.get('roomKey')
            };

            // Get the token from localStorage
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('No token found. Please login first.');
                return;
            }

            console.log("Submitting create club with data:", data);

            // Send the data to the backend with the Authorization header
            try {
                const response = await fetch('http://localhost:3000/api/club/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,  // Send the JWT token in the header
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();
                if (response.ok) {
                    console.log('Club created successfully:', result);
                    alert('Club created successfully!');
                } else {
                    console.error('Error creating club:', result.message);
                    alert('Error creating club: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Attach event listeners to forms
        document.getElementById('loginForm').addEventListener('submit', submitLoginForm);
        document.getElementById('createClubButton').addEventListener('click', submitCreateClubForm); // Attach to the correct button

        // Search Google Books API
        async function searchBooks(event) {
    event.preventDefault();

    const query = document.getElementById('query').value;
    try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';

        if (data.items && data.items.length > 0) {
            data.items.forEach(book => {
                const bookDiv = document.createElement('div');

                const addToUserButton = document.createElement('button');
                addToUserButton.textContent = 'Add to My Library';
                addToUserButton.addEventListener('click', () => {
                    addBookToLibrary(book.id, 'user');
                });

                const addToClubButton = document.createElement('button');
                addToClubButton.textContent = 'Add to Club Library';

                addToClubButton.addEventListener('click', async () => {
                const clubId = await selectClub(); // Call a function to fetch and select a club
                if (clubId) {
                addBookToLibrary(book.id, 'club', clubId);
                    }
                });

                bookDiv.innerHTML = `
                    <p><strong>${book.volumeInfo.title}</strong> by ${book.volumeInfo.authors?.join(', ') || 'Unknown'}</p>
                `;
                bookDiv.appendChild(addToUserButton);
                bookDiv.appendChild(addToClubButton);

                resultsContainer.appendChild(bookDiv);
            });
        } else {
            resultsContainer.innerHTML = '<p>No results found.</p>';
        }
    } catch (error) {
        console.error('Error searching Google Books:', error);
    }
}
document.getElementById('searchBooksButton').addEventListener('click', searchBooks);


// Add book to library
async function addBookToLibrary(bookId, targetType, clubId = null) {
    console.log('addBookToLibrary called with:', bookId, targetType, clubId);

    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('You must be logged in to add books.');
        return;
    }

    const payload = {
        googleId: bookId,
        targetType,
    };

    // Add `clubId` to the payload if the target type is "club"
    if (targetType === 'club') {
        if (!clubId) {
            alert('Club ID is required to add a book to a club.');
            return;
        }
        payload.clubId = clubId;
    }

    try {
        const response = await fetch('http://localhost:3000/api/books/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
        });

        const result = await response.json();
        console.log('Backend Response:', result);

        if (response.ok) {
            alert('Book added successfully!');
        } else {
            alert('Error adding book: ' + result.message);
        }
    } catch (error) {
        console.error('Error adding book to library:', error);
    }
}

// Fetch clubs and allow user to select one
async function selectClub() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('You must be logged in to view your clubs.');
        return null;
    }

    try {
        const response = await fetch('http://localhost:3000/api/club/my-clubs', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
        });

        if (!response.ok) {
            const result = await response.json();
            alert('Error fetching clubs: ' + result.message);
            return null;
        }

        const clubs = await response.json();

        // Create a dropdown to select a club
        const dropdown = document.createElement('select');
        dropdown.id = 'clubSelect';
        dropdown.innerHTML = clubs
            .map(club => `<option value="${club._id}">${club.name}</option>`)
            .join('');
        
        // Show the dropdown to the user
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'Confirm';
        confirmButton.addEventListener('click', () => {
            const selectedClubId = document.getElementById('clubSelect').value;
            document.body.removeChild(dropdownContainer); // Remove dropdown from DOM
            resolve(selectedClubId); // Return the selected club ID
        });

        const dropdownContainer = document.createElement('div');
        dropdownContainer.appendChild(dropdown);
        dropdownContainer.appendChild(confirmButton);

        document.body.appendChild(dropdownContainer);

        return new Promise(resolve => {
            confirmButton.addEventListener('click', () => {
                resolve(dropdown.value);
            });
        });
    } catch (error) {
        console.error('Error fetching clubs:', error);
        alert('Error fetching clubs');
        return null;
    }
}
// Add book to club library
async function addBookToClubLibrary(bookId, clubId) {
    console.log('addBookToClubLibrary called with:', bookId, clubId);

    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('You must be logged in to add books.');
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/club/${clubId}/add-book`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
            },
            body: JSON.stringify({ bookId }), // Send bookId in the body
        });

        const result = await response.json();
        if (response.ok) {
            alert('Book added to club library successfully!');
        } else {
            console.error('Error adding book to club library:', result.message);
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error('Error adding book to club library:', error);
        alert('An error occurred while adding the book to the club library.');
    }
}

    </script>
</body>
</html>
