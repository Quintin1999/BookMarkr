<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookMarkr</title>
</head>
<body>
    <h1>API Testing Form</h1>

    <!-- Create User -->
    <h2>Create User</h2>
    <form action="http://localhost:3000/api/users/create" method="POST">
        <label for="username">Username:</label>
        <input type="text" name="username" id="username" required><br>

        <label for="email">Email:</label>
        <input type="email" name="email" id="email" required><br>

        <label for="password">Password:</label>
        <input type="password" name="password" id="password" required><br>

        <button type="submit">Create User</button>
    </form>

    <!-- Login -->
    <h2>Login</h2>
    <form id="loginForm">
        <label for="loginEmail">Email:</label>
        <input type="email" id="loginEmail" name="email" required><br>

        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" name="password" required><br>

        <button type="submit">Login</button>
    </form>

    <!-- Create Club -->
    <h2>Create Club</h2>
    <form id="createClubForm">
        <label for="name">Club Name:</label>
        <input type="text" name="name" id="name" required><br>

        <label for="description">Description:</label>
        <input type="text" name="description" id="description"><br>

        <label for="roomKey">Room Key:</label>
        <input type="text" name="roomKey" id="roomKey" required><br>

        <button type="button" id="createClubButton">Create Club</button>
    </form>

    <!-- Search Google Books -->
    <h2>Search Google Books</h2>
    <form id="searchBooksForm">
        <label for="query">Search:</label>
        <input type="text" name="query" id="query" required>
        <button type="button" id="searchBooksButton">Search</button>
    </form>
    <div id="searchResults"></div>

    <script>
        // Login form submission
        async function submitLoginForm(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('http://localhost:3000/api/users/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem('jwtToken', result.token);
                    alert('Login successful');
                } else {
                    alert('Login failed: ' + result.message);
                }
            } catch (error) {
                console.error('Error during login:', error);
                alert('Error during login');
            }
        }

        // Create Club
        async function submitCreateClubForm(event) {
            event.preventDefault();
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('No token found. Please login first.');
                return;
            }

            const form = document.getElementById('createClubForm');
            const data = {
                name: form.name.value,
                description: form.description.value,
                roomKey: form.roomKey.value,
            };

            try {
                const response = await fetch('http://localhost:3000/api/club/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Club created successfully!');
                } else {
                    alert('Error creating club: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Search Books
        async function searchBooks(event) {
            event.preventDefault();
            const query = document.getElementById('query').value;

            if (!query) {
                alert('Please enter a search term.');
                return;
            }

            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = '';

                if (data.items && data.items.length > 0) {
                    data.items.forEach((book) => {
                        const bookDiv = document.createElement('div');

                        const addToUserButton = document.createElement('button');
                        addToUserButton.textContent = 'Add to My Library';
                        addToUserButton.addEventListener('click', () => {
                            addBookToLibrary(book.id, 'user');
                        });

                        const addToClubButton = document.createElement('button');
                        addToClubButton.textContent = 'Add to Club Library';
                        addToClubButton.addEventListener('click', async () => {
                            const clubId = await selectClub();
                            if (clubId) {
                                addBookToLibrary(book.id, 'club', clubId);
                            }
                        });

                        bookDiv.innerHTML = `
                            <p><strong>${book.volumeInfo.title}</strong> by ${book.volumeInfo.authors?.join(', ') || 'Unknown'}</p>
                        `;
                        bookDiv.appendChild(addToUserButton);
                        bookDiv.appendChild(addToClubButton);

                        resultsContainer.appendChild(bookDiv);
                    });
                } else {
                    resultsContainer.innerHTML = '<p>No results found.</p>';
                }
            } catch (error) {
                console.error('Error searching Google Books:', error);
                alert('Error searching books.');
            }
        }

        // Add Book to Library
        async function addBookToLibrary(bookId, targetType, clubId = null) {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('You must be logged in to add books.');
        return;
    }

    const payload = { googleId: bookId, targetType };
    if (targetType === 'club') payload.clubId = clubId;

    try {
        const response = await fetch('http://localhost:3000/api/books/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
        });

        const result = await response.json();
        if (response.ok) {
            alert('Book added successfully!');
        } else if (response.status === 403) {
            alert('Only the club owner can add books to this club.');
        } else {
            alert('Error adding book: ' + result.message);
        }
    } catch (error) {
        console.error('Error adding book to library:', error);
    }
}

      // Select Club
// Fetch clubs and allow the user to select one
async function selectClub() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('You must be logged in to view your clubs.');
        return null;
    }

    try {
        const response = await fetch('http://localhost:3000/api/club/my-clubs', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
        });

        if (!response.ok) {
            const result = await response.json();
            alert('Error fetching clubs: ' + result.message);
            return null;
        }

        const clubs = await response.json();

        if (clubs.length === 0) {
            alert('No clubs available to select.');
            return null;
        }

        return new Promise((resolve) => {
            const dropdownContainer = document.createElement('div');
            dropdownContainer.id = 'clubDropdownContainer';

            const dropdown = document.createElement('select');
            dropdown.id = 'clubSelect';

            clubs.forEach((club) => {
                if (club.role === 'Owner') { // Filter to only show clubs where the user is the owner
                    const option = document.createElement('option');
                    option.value = club._id;
                    option.textContent = club.name;
                    dropdown.appendChild(option);
                }
            });

            if (!dropdown.childNodes.length) {
                alert('You do not own any clubs to add books to.');
                return null;
            }

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'Confirm';
            confirmButton.addEventListener('click', () => {
                const selectedClubId = dropdown.value;
                document.body.removeChild(dropdownContainer);
                resolve(selectedClubId);
            });

            dropdownContainer.appendChild(dropdown);
            dropdownContainer.appendChild(confirmButton);
            document.body.appendChild(dropdownContainer);
        });
    } catch (error) {
        console.error('Error fetching clubs:', error);
        alert('Error fetching clubs. Check the console for details.');
        return null;
    }
}


        // Attach event listeners
        document.getElementById('loginForm').addEventListener('submit', submitLoginForm);
        document.getElementById('createClubButton').addEventListener('click', submitCreateClubForm);
        document.getElementById('searchBooksButton').addEventListener('click', searchBooks);
    </script>
</body>
</html>